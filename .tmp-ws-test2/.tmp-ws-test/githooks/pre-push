#!/usr/bin/env bash
set -euo pipefail

# Orchestrator firewall integration: block orchestrator from pushing when firewall is on
if [ -x "scripts/orchestrator_firewall.sh" ]; then
  ORCHESTRATION_ACTOR="${ORCHESTRATION_ACTOR:-unknown}" ./scripts/orchestrator_firewall.sh write repo || exit $?
fi

# Blocks push if `.verified` is missing or stale vs working tree
ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

VERIFIED_FILE=".verified"

err() { echo "pre-push: $*" >&2; }

if [ ! -f "$VERIFIED_FILE" ]; then
  err "Missing .verified — run: bash scripts/finalize.sh"
  exit 1
fi

if ! grep -q '^status: PASS' "$VERIFIED_FILE"; then
  err ".verified does not indicate PASS — run: bash scripts/finalize.sh"
  exit 1
fi

# Cross-platform file mtime
file_mtime() {
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

VERIFIED_MTIME=$(file_mtime "$VERIFIED_FILE")

# Compare against all tracked files (excluding orchestration artifacts)
STALE=0
while IFS= read -r f; do
  [ -e "$f" ] || continue
  case "$f" in
    .verified|.orchestration/*) continue ;;
  esac
  FMTIME=$(file_mtime "$f")
  if [ "$FMTIME" -gt "$VERIFIED_MTIME" ]; then
    err "Stale verification: '$f' modified after .verified. Run finalize."
    STALE=1
  fi
done < <(git ls-files)

if [ "$STALE" -eq 1 ]; then
  err "Push blocked. Run: bash scripts/finalize.sh"
  exit 1
fi

exit 0
