#!/bin/bash
#
# Git Pre-Commit Hook - File Organization Enforcement (Layer 4)
#
# Prevents commits that contain files in forbidden directories.
# This is the last checkpoint before code enters the repository.
#
# Performance target: <100ms (runs only on commit)
#

# Start timing
START_TIME=$(perl -MTime::HiRes=time -e 'printf "%.6f", time')

echo "üõ°Ô∏è  Running file organization checks..."

# Determine verification mode (default strict)
VERIFY_MODE="${CLAUDE_VERIFY_MODE:-strict}"
if [ -f .orchestration/mode.json ]; then
  MODE_VALUE=$(sed -n 's/.*"verify_mode"\s*:\s*"\([^"]*\)".*/\1/p' .orchestration/mode.json | head -1)
  if [ -n "$MODE_VALUE" ]; then
    VERIFY_MODE="$MODE_VALUE"
  fi
fi

# Check for forbidden directories in staged files
FORBIDDEN=$(git diff --cached --name-only | grep -E '^\.(orchestration|workshop|secret)/')

if [ -n "$FORBIDDEN" ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: Forbidden directories detected"
  echo ""
  echo "The following files are in deprecated directories:"
  echo "$FORBIDDEN" | sed 's/^/   /'
  echo ""
  echo "Allowed locations:"
  echo "   - .claude-work/memory/    (persistent data)"
  echo "   - .claude-work/sessions/  (session artifacts)"
  echo "   - .claude-work/temp/      (temporary files)"
  echo "   - src/docs/tests/         (source code)"
  echo ""
  echo "To fix:"
  echo "   1. Move files to .claude-work/"
  echo "   2. Use FileRegistry.write() for orchestration files"
  echo "   3. Run migration script: ./scripts/migrate-to-claude-work.sh"
  echo ""

  # Calculate duration
  END_TIME=$(perl -MTime::HiRes=time -e 'printf "%.6f", time')
  DURATION=$(echo "($END_TIME - $START_TIME) * 1000" | bc)

  echo "üõ°Ô∏è  Layer: Git pre-commit hook (Layer 4/6)"
  echo "   Duration: ${DURATION}ms"
  echo ""

  exit 1  # Block commit
fi

# ORCA gating: if this repo has an active ORCA session, require .verified (unless mode=off)
if [ -d .orchestration ]; then
  if [ "$VERIFY_MODE" = "off" ]; then
    echo "‚ö†Ô∏è  Verification disabled (verify_mode=off); skipping .verified requirement."
  elif [ -f .orchestration/orca-session ] || [ -f .orchestration/implementation-log.md ] || [ -f .orchestration/user-request.md ]; then
    if [ ! -f .verified ]; then
      echo ""
      echo "‚ùå COMMIT BLOCKED: .verified missing for active ORCA session"
      echo ""
      echo "Run finalization to generate .verified:"
      echo "   bash scripts/finalize.sh"
      echo ""
      exit 1
    fi
  fi
fi

# Check for large files in global archive
if [ -d ~/.claude-global/archive ]; then
  LARGE_ARCHIVE=$(find ~/.claude-global/archive -type f -size +10M 2>/dev/null)

  if [ -n "$LARGE_ARCHIVE" ]; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: Large files detected in global archive (>10MB)"
    echo "$LARGE_ARCHIVE" | sed 's/^/   /'
    echo ""
    echo "Consider:"
    echo "   - Running cleanup: ./scripts/cleanup-archives.sh"
    echo "   - Archive is auto-cleaned monthly (keeps last 3 months)"
    echo ""
  fi
fi

# Check for .claude-work in commits (should be in .gitignore)
CLAUDE_WORK=$(git diff --cached --name-only | grep -E '^\.claude-work/')

if [ -n "$CLAUDE_WORK" ]; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: .claude-work/ files in commit"
  echo ""
  echo ".claude-work/ should normally be in .gitignore"
  echo ""
  echo "Files:"
  echo "$CLAUDE_WORK" | sed 's/^/   /'
  echo ""
  read -p "Continue anyway? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Calculate total duration
END_TIME=$(perl -MTime::HiRes=time -e 'printf "%.6f", time')
DURATION=$(echo "($END_TIME - $START_TIME) * 1000" | bc)

echo "‚úì File organization check passed (${DURATION}ms)"
echo ""

exit 0
