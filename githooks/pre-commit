#!/usr/bin/env bash
set -euo pipefail

# Orchestrator firewall integration: block orchestrator from committing when firewall is on
if [ -x "scripts/orchestrator_firewall.sh" ]; then
  ORCHESTRATION_ACTOR="${ORCHESTRATION_ACTOR:-unknown}" ./scripts/orchestrator_firewall.sh write repo || exit $?
fi

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

err() { echo "pre-commit: $*" >&2; }

# Bypass options for trusted/tweak sessions
if [ "${VERIFY_BYPASS:-}" = "1" ] || [ "${GIT_VERIFY:-on}" = "off" ]; then
  err "Verification bypassed by environment"
  exit 0
fi

# Read verification mode from mode file
VERIFY_MODE="strict"
if [ -f ".orchestration/mode.json" ]; then
  VM=$(sed -n 's/.*"verify_mode"\s*:\s*"\([^"]*\)".*/\1/p' .orchestration/mode.json | head -1)
  VERIFY_MODE=${VM:-strict}
fi

# Cross-platform file mtime
file_mtime() {
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

# Allow commit without checks when verification is OFF
if [ "$VERIFY_MODE" = "off" ]; then
  err "Verification disabled (verify_mode=off)"
  exit 0
fi

USE_TWEAK=0
if [ "$VERIFY_MODE" = "tweak" ]; then
  USE_TWEAK=1
fi

MARKER=".verified"
if [ "$USE_TWEAK" -eq 1 ]; then
  MARKER=".tweak_verified"
fi

if [ ! -f "$MARKER" ]; then
  if [ "$USE_TWEAK" -eq 1 ]; then
    err "Missing $MARKER — run: bash scripts/quick-confirm.sh"
  else
    err "Missing .verified — run: bash scripts/finalize.sh"
  fi
  exit 1
fi

if ! grep -q '^status: PASS' "$MARKER"; then
  err "$MARKER does not indicate PASS — run the appropriate confirmation"
  exit 1
fi

MARKER_MTIME=$(file_mtime "$MARKER")

# Files staged for commit
STAGED=$(git diff --cached --name-only)

# If nothing is staged, allow commit (e.g., merging with no changes)
if [ -z "$STAGED" ]; then
  exit 0
fi

exclude_path() {
  case "$1" in
    .verified|.tweak_verified) return 0 ;;
    .orchestration/*) return 0 ;;
    *) return 1 ;;
  esac
}

STALE=0
while IFS= read -r f; do
  [ -e "$f" ] || continue
  if exclude_path "$f"; then
    continue
  fi
  FMTIME=$(file_mtime "$f")
  if [ "$FMTIME" -gt "$MARKER_MTIME" ]; then
    if [ "$USE_TWEAK" -eq 1 ]; then
      err "Stale tweak verification: '$f' modified after $MARKER. Run: bash scripts/quick-confirm.sh"
    else
      err "Stale verification: '$f' modified after .verified. Run finalize."
    fi
    STALE=1
  fi
done <<< "$STAGED"

if [ "$STALE" -eq 1 ]; then
  exit 1
fi

exit 0
